<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Socket.IO chat</title>
</head>
<body>
<header>
    <button>Выйти</button>
</header>
<form action="" id="authForm">
    <input class="authInput" id="loginInput">
    <input class="authInput" id="passwordInput" type="password">
    <button>Войти</button>
</form>
<div>
    <div id="messages"></div>
    <form id="form" action="">
        <input id="input" autocomplete="off"/>
        <button>Send</button>
    </form>
</div>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script type="module" src="./script.js"></script>
<script type="module">
    import {auth, sendMessage, clearMessages, viewMessage, loadMessages} from './script.js';


    const socket = io();
    const authForm = document.getElementById('authForm');
    const loginInput = document.getElementById('loginInput');
    const passwordInput = document.getElementById('passwordInput');

    const form = document.getElementById('form');
    const message = document.getElementById('input');

    const getMessageListRequest = new XMLHttpRequest();

    const messagesList = document.getElementById('messages');


    socket.on('getLastMsg', (message) => {
        viewMessage(message, messagesList);
    });

    socket.on('disconnect', () => {
        localStorage.setItem('accessToken', null);
        localStorage.setItem('userId', null);
        authForm.style.display = 'block';
        messagesList.style.display = 'none';
        form.style.display = 'none';
    });


    authForm.addEventListener('submit', (event) => {
        event.preventDefault();
        auth(loginInput.value, passwordInput.value, socket)
            .then((token) => {
                authForm.style.display = 'none';
                messagesList.style.display = 'block';
                form.style.display = 'flex';
                socket.emit('auth', token);
                console.log('!!!!', token);
                clearMessages();
                loadMessages(getMessageListRequest);
            })
            .catch((err) => console.log(err));
    });

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        if (message.value) {
            sendMessage(message.value)
                .then(({data}) => {
                    socket.emit('message', data.message);
                    viewMessage(data.message, messagesList);
                    message.value = '';
                })
                .catch(console.log);
        }
    });

    function killToken() {
    }

    window.onload = () => {
        if (localStorage.getItem('accessToken') === 'null') {
            authForm.style.display = 'block';
            messagesList.style.display = 'none';
            form.style.display = 'none';
        } else {
            socket.emit('auth', localStorage.getItem('accessToken'));
            clearMessages();
            loadMessages(getMessageListRequest);
        }
    };
</script>
</body>
</html>
